<div id="wrapper" class="browser-style">
    <div id="filter_box">
        <form on:submit="activateTopTab()">
            <input type="search"
                ref:filterbox 
                bind:value="filter"
                placeholder="Filter...">
        </form>
    </div>
    {{#await filtered_windows}}
    <Loading/>
    {{then answer}}
    {{#each answer as win @id}}
    <div class="window panel-section-list">
        <div class="panel-section-header no-overflow">
            <span class="text-section-header ellipsis">{{ win.title }}</span>
        </div>
        {{#each win.tabs as tab @id}}
        <div class="tab panel-list-item"
                on:click="activateTab(tab.id)">
            <div
                class="container-check no-overflow"
                data-has-container="{{tab.container ? 'yes' : 'no'}}"
                style="border-bottom-color: {{tab.container ? tab.container.colorCode : black}};">
                {{#if tab.favIconUrl}}
                <img class="icon"
                    src="{{ tab.favIconUrl }}"
                    on:error="noFavicon(tab)"
                    alt="favicon" width="16" height="16">
                {{else}}
                <img class="icon" src="palette/static/folder-16.svg" alt="no favicon" width="16" height="16">
                {{/if}}
                <span class="text ellipsis">{{ tab.title }}</span>
            </div>
        </div>
        {{/each}}
    </div>
    {{/each}}
    {{catch error}}
    <p>An error occured!</p>
    <pre>{{ error }}</pre>
    {{/await}}
</div>

<style>
    #wrapper {
        display: flex;
        flex-direction: column;
        width: 500px;
        height: 500px;
        padding: 10px;
        overflow-x: hidden;
    }

    input[type="search"] {
        width: 100%;
    }

    .no-overflow {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .ellipsis {
        width: auto;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    .tab > * {
        margin-right: 10px;
    }

    .container-check[data-has-container="yes"] {
        position: relative;
        max-width: 100%;
    }

    .container-check[data-has-container="yes"]::after {
        content: '';
        border-bottom: 2px solid;
        border-bottom-color: inherit;
        position: absolute;
        left: 0;
        top: calc(100% - 2px);
        width: 100%;
    }
</style>

<script>
    import Loading from './Loading.html';

    export default {
        data () {
            return {
                windows: browser.windows.getAll({
                    populate: true,
                    windowTypes: ['normal']
                }),
                containers: browser.contextualIdentities.query({}),
                filter: ""
            };
        },

        computed: {
            containers_by_id: containers => {
                return containers.then(contexts => {
                    let containers = {};
                    for (let i = 0; i < contexts.length; i++) {
                        containers[contexts[i].cookieStoreId] = contexts[i];
                    }
                    return containers;
                })
            },
            complete_windows: (windows, containers_by_id) => {
                return Promise.all([windows, containers_by_id])
                    .then(([windows, containers]) => {
                        for (let i = 0; i < windows.length; i++) {
                            for (let j = 0; j < windows[i].tabs.length; j++) {
                                const container_id = windows[i].tabs[j].cookieStoreId;
                                if (container_id && containers.hasOwnProperty(container_id)) {
                                    windows[i].tabs[j].container = containers[container_id];
                                }
                            }
                        }
                        return windows;
                    });
            },
            filtered_windows: (complete_windows, filter) => {
                if (filter.length == 0) {
                    return complete_windows;
                }
                return complete_windows.then(windows => {
                    let new_windows = [];
                    const regex = new RegExp(filter, 'i');
                    for (let i = 0; i < windows.length; i++) {
                        let temp = [];
                        for (let j = 0; j < windows[i].tabs.length; j++) {
                            if (windows[i].tabs[j].title.match(regex)) {
                                temp.push(windows[i].tabs[j]);
                            }
                        }

                        if (temp.length > 0) {
                            new_windows.push({
                                tabs: temp,
                                title: windows[i].title
                            });
                        }
                    }

                    return new_windows;
                });
            }
        },

        oncreate () {
            this.refs.filterbox.focus();
        },

        methods: {
            activateTab: function(tab_id) {
                browser.tabs.update(tab_id, { active: true }).then((tab) => {
                    return browser.windows.update(tab.windowId, { focused: true });
                }).then((win) => {
                    window.close();
                }).catch((err) => {
                    console.error(err);
                });
            },

            activateTopTab: function() {
                this.get("filtered_windows").then(filtered_windows => {
                    if (filtered_windows.length == 0) {
                        return;
                    }
                    if (filtered_windows[0].tabs.length == 0) {
                        return;
                    }
                    const tab = filtered_windows[0].tabs[0];
                    console.log(`Switching to tab ${tab.id} in window ${tab.windowId}`);
                    this.activateTab(tab.id);
                });
            },

            noFavicon: function(tab) {
                tab.favIconUrl = null;
            }
        },

        components: {
            Loading
        }
    }
</script>
